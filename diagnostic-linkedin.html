<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic LinkedIn - AE2I</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1 {
            color: #0077B5;
            margin-bottom: 10px;
        }
        h2 {
            color: #333;
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .status {
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            word-break: break-all;
        }
        pre {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        button {
            background: #0077B5;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #005885;
        }
        .copy-btn {
            background: #6c757d;
            font-size: 12px;
            padding: 5px 10px;
        }
        .copy-btn:hover {
            background: #5a6268;
        }
    </style>
</head>
<body>
    <div class="card">
        <h1>üîç Diagnostic LinkedIn - AE2I</h1>
        <p>Ce script v√©rifie votre configuration LinkedIn et identifie les probl√®mes.</p>
        
        <button onclick="runDiagnostic()">üöÄ Lancer le Diagnostic</button>
        <button onclick="clearResults()">üóëÔ∏è Effacer les R√©sultats</button>
        
        <div id="results"></div>
    </div>

    <script>
        const R2_CONFIG = {
            workerUrl: 'https://upload-ae2i.ae2ialgerie2025.workers.dev'
        };

        async function runDiagnostic() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<h2>‚è≥ Diagnostic en cours...</h2>';
            
            let html = '<h2>üìä R√©sultats du Diagnostic</h2>';
            
            // 1. V√©rifier l'URL actuelle
            html += '<div class="status info">';
            html += '<strong>1. URL Actuelle:</strong><br>';
            html += `<code>${window.location.href}</code>`;
            html += '</div>';
            
            // 2. V√©rifier l'origine
            html += '<div class="status info">';
            html += '<strong>2. Origine:</strong><br>';
            html += `<code>${window.location.origin}</code>`;
            html += '</div>';
            
            // 3. V√©rifier le pathname
            html += '<div class="status info">';
            html += '<strong>3. Chemin (Pathname):</strong><br>';
            html += `<code>${window.location.pathname}</code>`;
            html += '</div>';
            
            // 4. Calculer l'URL de redirection attendue
            let pathname = window.location.pathname;
            if (pathname === '/carriere') {
                pathname = '/carriere/';
            }
            const expectedRedirectUri = window.location.origin + pathname;
            
            html += '<div class="status warning">';
            html += '<strong>4. URL de Redirection Attendue:</strong><br>';
            html += `<code>${expectedRedirectUri}</code>`;
            html += '<br><small>‚ö†Ô∏è Cette URL doit √™tre EXACTEMENT la m√™me dans LinkedIn</small>';
            html += '</div>';
            
            // 5. V√©rifier le Worker
            html += '<div class="status info">';
            html += '<strong>5. Test du Worker:</strong><br>';
            html += `<code>${R2_CONFIG.workerUrl}/linkedin/key</code><br>`;
            html += '<span id="worker-test">‚è≥ Test en cours...</span>';
            html += '</div>';
            
            try {
                const workerResponse = await fetch(`${R2_CONFIG.workerUrl}/linkedin/key`);
                const workerData = await workerResponse.json();
                
                if (workerResponse.ok && workerData.client_id) {
                    html = html.replace(
                        '<span id="worker-test">‚è≥ Test en cours...</span>',
                        `<span class="success">‚úÖ Worker r√©pond correctement<br>Client ID: <code>${workerData.client_id.substring(0, 10)}...</code></span>`
                    );
                } else {
                    html = html.replace(
                        '<span id="worker-test">‚è≥ Test en cours...</span>',
                        `<span class="error">‚ùå Erreur Worker: ${workerData.error || 'R√©ponse invalide'}</span>`
                    );
                }
            } catch (error) {
                html = html.replace(
                    '<span id="worker-test">‚è≥ Test en cours...</span>',
                    `<span class="error">‚ùå Erreur de connexion au Worker: ${error.message}</span>`
                );
            }
            
            // 6. V√©rifier localStorage
            const savedRedirectUri = localStorage.getItem('linkedin_debug_redirect_uri');
            html += '<div class="status info">';
            html += '<strong>6. URL Sauvegard√©e (localStorage):</strong><br>';
            if (savedRedirectUri) {
                html += `<code>${savedRedirectUri}</code>`;
                if (savedRedirectUri !== expectedRedirectUri) {
                    html += '<br><span class="warning">‚ö†Ô∏è L\'URL sauvegard√©e ne correspond pas √† l\'URL attendue!</span>';
                }
            } else {
                html += '<span class="warning">Aucune URL sauvegard√©e</span>';
            }
            html += '</div>';
            
            // 7. V√©rifier les param√®tres URL
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            const errorDescription = urlParams.get('error_description');
            
            html += '<div class="status info">';
            html += '<strong>7. Param√®tres URL:</strong><br>';
            if (code) {
                html += `<span class="success">‚úÖ Code d'autorisation pr√©sent: <code>${code.substring(0, 20)}...</code></span><br>`;
            }
            if (error) {
                html += `<span class="error">‚ùå Erreur LinkedIn: <code>${error}</code></span><br>`;
                if (errorDescription) {
                    html += `<span class="error">Description: <code>${errorDescription}</code></span><br>`;
                }
            }
            if (!code && !error) {
                html += '<span class="warning">Aucun param√®tre LinkedIn dans l\'URL</span>';
            }
            html += '</div>';
            
            // 8. Instructions
            html += '<div class="status warning">';
            html += '<strong>üìã Instructions pour LinkedIn:</strong><br>';
            html += '1. Allez sur <a href="https://www.linkedin.com/developers/apps" target="_blank">LinkedIn Developers</a><br>';
            html += '2. S√©lectionnez votre application<br>';
            html += '3. Allez dans l\'onglet <strong>"Auth"</strong><br>';
            html += '4. Dans <strong>"Authorized redirect URLs"</strong>, ajoutez EXACTEMENT cette URL:<br>';
            html += `<code style="display: block; margin: 10px 0; padding: 10px; background: #fff; border: 2px solid #0077B5;">${expectedRedirectUri}</code>`;
            html += '<button class="copy-btn" onclick="copyToClipboard(\'' + expectedRedirectUri + '\')">üìã Copier</button>';
            html += '<br><br>';
            html += '<strong>‚ö†Ô∏è IMPORTANT:</strong><br>';
            html += '- L\'URL doit correspondre EXACTEMENT (m√™me protocole, m√™me domaine, m√™me chemin, m√™me slash final)<br>';
            html += '- Si votre URL est <code>https://ae2i-b6c7f.web.app/carriere/</code>, elle doit √™tre exactement comme √ßa dans LinkedIn<br>';
            html += '- Si votre URL est <code>https://ae2i-b6c7f.web.app/carriere</code> (sans slash), elle doit √™tre exactement comme √ßa dans LinkedIn';
            html += '</div>';
            
            // 9. V√©rifier les scopes
            html += '<div class="status info">';
            html += '<strong>8. Scopes Requis:</strong><br>';
            html += 'Votre application LinkedIn doit avoir ces permissions activ√©es:<br>';
            html += '- <code>openid</code> (pour OAuth 2.0)<br>';
            html += '- <code>profile</code> (pour les informations de profil)<br>';
            html += '- <code>email</code> (pour l\'adresse email)<br>';
            html += '<br>V√©rifiez dans LinkedIn ‚Üí Votre App ‚Üí Auth ‚Üí Products ‚Üí "Sign In with LinkedIn using OpenID Connect"';
            html += '</div>';
            
            resultsDiv.innerHTML = html;
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('‚úÖ URL copi√©e dans le presse-papiers!\n\nCollez-la maintenant dans LinkedIn ‚Üí Auth ‚Üí Authorized redirect URLs');
            });
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
        
        // Lancer automatiquement au chargement
        window.addEventListener('load', () => {
            runDiagnostic();
        });
    </script>
</body>
</html>

